import React, { createContext, useContext, useState, useEffect, useRef } from 'react';
import * as Notifications from 'expo-notifications';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useAuth } from './AuthContext';

const NotificationContext = createContext();

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

export const NotificationProvider = ({ children }) => {
  const { user } = useAuth();
  const [notifications, setNotifications] = useState([]);
  const [isEnabled, setIsEnabled] = useState(true);
  const [expoPushToken, setExpoPushToken] = useState(null);
  const notificationListener = useRef();
  const responseListener = useRef();

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
  useEffect(() => {
    setupNotifications();

    return () => {
      // ÐÐ° web ÑÑ‚Ð¸Ñ… subscriptions Ð½ÐµÑ‚, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
      if (notificationListener.current) {
        Notifications.removeNotificationSubscription(notificationListener.current);
      }
      if (responseListener.current) {
        Notifications.removeNotificationSubscription(responseListener.current);
      }
    };
  }, [user?.id]);

  const getApiUrl = () => {
    // ÐÐ° web Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ localhost
    if (typeof window !== 'undefined') {
      return 'http://localhost:5002/api';
    }
    // ÐÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ…
    return 'http://localhost:5002/api';
  };

  const setupNotifications = async () => {
    try {
      // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½, Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼
      if (!user?.id) {
        console.log('â„¹ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½, ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ');
        return;
      }

      // âœ… Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
      console.log('ðŸ“¡ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ userId:', user.id);
      const apiUrl = getApiUrl();
      const response = await fetch(`${apiUrl}/notifications/${user.id}`);
      
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.notifications) {
          console.log('âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°:', data.notifications.length, 'Ð¢Ð¸Ð¿Ñ‹:', data.notifications.map(n => ({ id: n.id, type: n.type, title: n.title })));
          setNotifications(data.notifications);
        }
      } else {
        console.warn('âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°:', response.status);
        // Fallback Ð½Ð° AsyncStorage ÐµÑÐ»Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
        const saved = await AsyncStorage.getItem('@notifications');
        if (saved) {
          console.log('ðŸ’¾ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¸Ð· AsyncStorage');
          setNotifications(JSON.parse(saved));
        }
      }

      // ÐÐ° web push notifications Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ VAPID key, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
      if (typeof window !== 'undefined') {
        console.log('â„¹ï¸ Push notifications Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹ Ð½Ð° web');
        return;
      }

      // Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð½Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
      const { status } = await Notifications.requestPermissionsAsync();
      if (status === 'granted') {
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ push-ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (Ð² production Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ)
        const token = await Notifications.getExpoPushTokenAsync();
        setExpoPushToken(token.data);
        await AsyncStorage.setItem('@expo_push_token', token.data);
      }

      // Ð¡Ð»ÑƒÑˆÐ°Ñ‚ÑŒ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
      notificationListener.current = Notifications.addNotificationReceivedListener(
        notification => {
          const newNotification = {
            id: notification.request.identifier,
            title: notification.request.content.title,
            body: notification.request.content.body,
            data: notification.request.content.data,
            timestamp: new Date().toISOString(),
            read: false,
          };
          setNotifications(prev => [newNotification, ...prev]);
        }
      );

      // Ð¡Ð»ÑƒÑˆÐ°Ñ‚ÑŒ Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ñ Ð½Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
      responseListener.current = Notifications.addNotificationResponseReceivedListener(
        response => {
          console.log('Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¶Ð°Ñ‚Ð¾:', response);
          // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸ÑŽ
        }
      );
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹:', error);
    }
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
  const sendNotification = async (title, body, data = {}) => {
    try {
      await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          data,
          sound: true,
          badge: 1,
        },
        trigger: { seconds: 1 }, // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ
      });
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', error);
    }
  };

  // Ð—Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
  const scheduleNotification = async (title, body, seconds = 60, data = {}) => {
    try {
      const notificationId = await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          data,
          sound: true,
          badge: 1,
        },
        trigger: { seconds },
      });
      return notificationId;
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', error);
    }
  };

  // Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  const addNotification = async (notificationData) => {
    try {
      if (!user?.id) {
        console.warn('âš ï¸ ÐÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½');
        return;
      }

      const apiUrl = getApiUrl();
      
      console.log('ðŸ”” addNotification: ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼:', notificationData.type, 'Ð”Ð°Ð½Ð½Ñ‹Ðµ:', notificationData);
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      const response = await fetch(`${apiUrl}/notifications/${user.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...notificationData,
          read: false,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        const newNotification = data.notification;
        console.log('ðŸ“Œ addNotification: ÐÐ¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼:', newNotification.type, 'Ð”Ð°Ð½Ð½Ñ‹Ðµ:', newNotification);
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        const updated = [newNotification, ...notifications];
        setNotifications(updated);
        
        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ fallback
        await AsyncStorage.setItem('@notifications', JSON.stringify(updated));
        console.log('âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾:', notificationData.message);
      } else {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€:', response.status);
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', error);
    }
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð½Ð¾Ð²Ð¾Ð¼ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸
  const notifyNewBooking = async (propertyName, guestName, checkIn, checkOut) => {
    console.log('ðŸ”” notifyNewBooking called:', { propertyName, guestName, checkIn, checkOut });
    await addNotification({
      type: 'newBooking',
      title: 'ÐÐ¾Ð²Ð¾Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ',
      message: `Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½ ${propertyName} Ñ ${checkIn} Ð¿Ð¾ ${checkOut}`,
      data: { property: propertyName, guestName, checkIn, checkOut },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ð¸ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  const notifyBookingConfirmed = async (propertyName, checkIn) => {
    await addNotification({
      type: 'bookingConfirmed',
      title: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾',
      message: `Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ${propertyName} Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾ Ð½Ð° ${checkIn}`,
      data: { property: propertyName, checkIn },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  const notifyBookingCompleted = async (propertyName, rating) => {
    await addNotification({
      type: 'bookingCompleted',
      title: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾',
      message: `Ð’Ð°ÑˆÐµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ${propertyName} Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾. ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ñ‚Ð·Ñ‹Ð²!`,
      data: { property: propertyName, rating },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾Ñ‚Ð¼ÐµÐ½Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  const notifyBookingCancelled = async (propertyName, refund) => {
    await addNotification({
      type: 'bookingCancelled',
      title: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾',
      message: `Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ${propertyName} Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¾ ${refund} PRB`,
      data: { property: propertyName, refund },
    });
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ðµ
  const notifyPaymentSuccess = async (amount, method) => {
    await addNotification({
      type: 'paymentSuccess',
      title: 'ÐŸÐ»Ð°Ñ‚Ñ‘Ð¶ ÑƒÑÐ¿ÐµÑˆÐµÐ½',
      message: `Ð¡ Ð²Ð°ÑˆÐµÐ¹ ÐºÐ°Ñ€Ñ‚Ñ‹ ÑÐ½ÑÑ‚Ð¾ ${amount} PRB Ñ‡ÐµÑ€ÐµÐ· ${method}`,
      data: { amount, method },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ð¾Ð¼ ÐºÑÑˆÐ±ÐµÐºÐµ
  const notifyCashbackReceived = async (amount, bookingId) => {
    await addNotification({
      type: 'cashbackReceived',
      title: 'ÐšÑÑˆÐ±ÐµÐº Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½',
      message: `Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ ${amount} PRB ÐºÑÑˆÐ±ÐµÐºÐ° Ð¾Ñ‚ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ`,
      data: { amount, bookingId },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð±Ð°Ð»Ð°Ð½ÑÐ°
  const notifyTopup = async (amount, method) => {
    await addNotification({
      type: 'topup',
      title: 'Ð‘Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½',
      message: `Ð‘Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð½Ð° ${amount} PRB`,
      data: { amount, method },
    });
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸
  const notifyEvent = async (eventName, date) => {
    await sendNotification(
      'ðŸŽ‰ ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ',
      `${eventName} Ð½Ð°Ñ‡Ð½Ñ‘Ñ‚ÑÑ ${date}`,
      { type: 'event', event: eventName }
    );
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ðµ
  const notifyReferral = async (friendName, bonus) => {
    const newNotification = {
      id: Date.now().toString(),
      type: 'referralBonus',
      title: 'Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ Ð±Ð¾Ð½ÑƒÑ',
      message: `${friendName} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ð¸ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ ${bonus} PRB`,
      data: { friend: friendName, bonus },
      createdAt: new Date(),
      read: false,
    };
    setNotifications(prev => [newNotification, ...prev]);
    await AsyncStorage.setItem('@notifications', JSON.stringify([newNotification, ...notifications]));
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð´Ñ€ÑƒÐ³ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ
  const notifyFriendJoined = async (friendName, bonusAmount) => {
    await addNotification({
      type: 'friendJoined',
      title: 'Ð”Ñ€ÑƒÐ³ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ',
      message: `${friendName} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ð¿Ð¾ Ð²Ð°ÑˆÐµÐ¹ ÑÑÑ‹Ð»ÐºÐµ Ð¸ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ ${bonusAmount} PRB`,
      data: { friend: friendName, bonus: bonusAmount },
    });
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾Ñ‚Ð·Ñ‹Ð²Ðµ
  const notifyReview = async (propertyName, rating) => {
    await addNotification({
      type: 'newReview',
      title: 'ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ñ‚Ð·Ñ‹Ð²',
      message: `ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ Ð²Ð¿ÐµÑ‡Ð°Ñ‚Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¾ ${propertyName} (${rating}â­)`,
      data: { property: propertyName, rating },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð½Ð¾Ð²Ð¾Ð¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ðµ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const notifyNewReviewPosted = async (propertyName, userName, rating) => {
    await addNotification({
      type: 'reviewNotification',
      title: 'ÐÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð·Ñ‹Ð²',
      message: `${userName} Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð¾Ñ‚Ð·Ñ‹Ð² Ð¾ ${propertyName}: ${rating}â­`,
      data: { property: propertyName, userName, rating },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð½Ð° Ð¾Ñ‚Ð·Ñ‹Ð²
  const notifyReviewReply = async (propertyName, ownerReply) => {
    await addNotification({
      type: 'reviewReply',
      title: 'ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð° Ð²Ð°Ñˆ Ð¾Ñ‚Ð·Ñ‹Ð²',
      message: `Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ† ${propertyName} Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» Ð½Ð° Ð²Ð°Ñˆ Ð¾Ñ‚Ð·Ñ‹Ð²`,
      data: { property: propertyName, ownerReply },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  const notifyEventCreated = async (eventName, eventType) => {
    await addNotification({
      type: 'eventCreated',
      title: 'âœ… Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾',
      message: `Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ "${eventName}" (${eventType}) ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾`,
      data: { event: eventName, eventType },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾Ð± Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  const notifyEventUpdated = async (eventName, changes) => {
    await addNotification({
      type: 'eventUpdated',
      title: 'âœï¸ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾',
      message: `Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ "${eventName}" Ð±Ñ‹Ð»Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾`,
      data: { event: eventName, changes },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  const notifyEventDeleted = async (eventName) => {
    await addNotification({
      type: 'eventDeleted',
      title: 'ðŸ—‘ï¸ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾',
      message: `Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ "${eventName}" Ð±Ñ‹Ð»Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾`,
      data: { event: eventName },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const notifyUserAdded = async (userName, userEmail) => {
    await addNotification({
      type: 'userAdded',
      title: 'âž• ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½',
      message: `ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ "${userName}" (${userEmail}) Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ`,
      data: { user: userName, email: userEmail },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const notifyUserDeleted = async (userName, userEmail) => {
    await addNotification({
      type: 'userDeleted',
      title: 'âž– ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½',
      message: `ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ "${userName}" (${userEmail}) ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹`,
      data: { user: userName, email: userEmail },
    });
  };

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾Ð± Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const notifyUserUpdated = async (userName, changes) => {
    await addNotification({
      type: 'userUpdated',
      title: 'âœï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½',
      message: `Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ "${userName}" Ð±Ñ‹Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹`,
      data: { user: userName, changes },
    });
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸
  const notifyAdminEvent = async (eventType, details) => {
    const messages = {
      new_user: `ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${details.name}`,
      new_booking: `ÐÐ¾Ð²Ð¾Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚ ${details.guestName}`,
      payment: `ÐŸÐ»Ð°Ñ‚Ñ‘Ð¶ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: ${details.amount} PRB`,
      review: `ÐÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð·Ñ‹Ð²: ${details.rating} Ð·Ð²Ñ‘Ð·Ð´`,
      report: `ÐžÑ‚Ñ‡Ñ‘Ñ‚: ${details.message}`,
    };

    await sendNotification(
      'ðŸ”” Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ',
      messages[eventType] || eventType,
      { type: 'admin_event', eventType, ...details }
    );
  };

  // ÐŸÐ¾Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ
  const markAsRead = async (notificationId) => {
    try {
      if (!user?.id) return;

      const apiUrl = getApiUrl();
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
      const response = await fetch(`${apiUrl}/notifications/${user.id}/${notificationId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        const updated = notifications.map(n =>
          n.id === notificationId ? { ...n, read: true } : n
        );
        setNotifications(updated);
        await AsyncStorage.setItem('@notifications', JSON.stringify(updated));
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ð³Ð¾:', error);
    }
  };

  // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
  const deleteNotification = async (notificationId) => {
    try {
      if (!user?.id) {
        // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
        const updated = notifications.filter(n => n.id !== notificationId);
        setNotifications(updated);
        await AsyncStorage.setItem('@notifications', JSON.stringify(updated));
        return;
      }

      const apiUrl = getApiUrl();
      
      try {
        // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        const response = await fetch(`${apiUrl}/notifications/${user.id}/${notificationId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (response.ok) {
          console.log('âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°:', notificationId);
        } else {
          console.warn('âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:', response.status);
        }
      } catch (serverError) {
        console.warn('âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', serverError.message);
      }

      // Ð’ Ð»ÑŽÐ±Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
      const updated = notifications.filter(n => n.id !== notificationId);
      setNotifications(updated);
      await AsyncStorage.setItem('@notifications', JSON.stringify(updated));
      console.log('âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾:', notificationId);
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', error);
    }
  };

  // ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  const clearAllNotifications = async () => {
    try {
      if (!user?.id) return;

      const apiUrl = getApiUrl();
      
      // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
      const response = await fetch(`${apiUrl}/notifications/${user.id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
        setNotifications([]);
        await AsyncStorage.setItem('@notifications', JSON.stringify([]));
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð²ÑÐµÑ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹:', error);
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  const getUnreadCount = () => {
    return notifications.filter(n => !n.read).length;
  };

  // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾/Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
  const toggleNotifications = async (enabled) => {
    setIsEnabled(enabled);
    await AsyncStorage.setItem('@notifications_enabled', String(enabled));
  };

  return (
    <NotificationContext.Provider
      value={{
        notifications,
        expoPushToken,
        isEnabled,
        notificationsEnabled: isEnabled,
        toggleNotifications,
        sendNotification,
        scheduleNotification,
        notifyNewBooking,
        notifyBookingConfirmed,
        notifyBookingCompleted,
        notifyBookingCancelled,
        notifyPaymentSuccess,
        notifyCashbackReceived,
        notifyTopup,
        notifyEvent,
        notifyReferral,
        notifyFriendJoined,
        notifyReview,
        notifyNewReviewPosted,
        notifyReviewReply,
        notifyAdminEvent,
        notifyEventCreated,
        notifyEventUpdated,
        notifyEventDeleted,
        notifyUserAdded,
        notifyUserDeleted,
        notifyUserUpdated,
        markAsRead,
        deleteNotification,
        clearAllNotifications,
        getUnreadCount,
      }}
    >
      {children}
    </NotificationContext.Provider>
  );
};

export const useNotification = () => {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotification must be used within NotificationProvider');
  }
  return context;
};
